\documentclass[]{article}

\usepackage{hyperref}
\usepackage{import}
\usepackage{listings}
\usepackage{minted}
\usepackage[dvipsnames]{xcolor}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{geometry}
 \geometry{
 a4paper,
 left=2.2cm,
 right=2.2cm,
 top=2.5cm,
 bottom=2.5cm
 }

\usepackage[localise]{xepersian}
\settextfont{Vazirmatn}
\setlatintextfont{Roboto}

% for listing environments
\colorlet{LightGray}{Gray!30!}

% for href
\eqcommand{تارنما}{href}

\عنوان{دلال پیام - قسمت اول}
\نویسنده{پرهام الوانی}
\تاریخ{۲ خرداد ۱۴۰۱}

\begin{document}
  \عنوان‌ساز
  \فهرست‌مطالب
  \صفحه‌شکن

  \قسمت{مقدمه}

  دلال پیام\پانویس{Message Broker} یک سرور است که پیام‌های دریافتی از کلاینت‌ها را بین آن‌ها تقسیم می‌کند. البته این دلال‌ها کارهای بیشتری هم انجام می‌دهند که خارج از بحث ما است.
  دو عملیات مهم در سرور وجود دارد یکی \متن‌لاتین{Publish} کردن و دیگری \متن‌لاتین{Subscribe} کردن است. در عملیات \متن‌لاتین{Subscribe} کلاینت درخواست گوش دادن رو یک موضوع\پانویس{Topic} خاص را می‌دهد.
  در \متن‌لاتین{Publish} کلاینت یک پیام را روی یک موضوع خاص منتشر می‌کند. در نهایت دلال پیام‌ها را به دست \متن‌سیاه{تمام} کسانی که روی آن موضوع گوش می‌دهند می‌رساند.
  در این قسمت تمامی ارتباط میان سرور و کلاینت در قالب \متن‌لاتین{TCP} پیاده‌سازی می‌شود.

  \شروع{شکل}[h]
  \تنظیم‌ازوسط
  \درج‌تصویر[width=.5\textwidth]{./img/overview.png}
  \شرح{شمای کلی یک دلال پیام}
  \پایان{شکل}

  \قسمت{دستورات}

  کلاینت به سرور:

  \شروع{توضیح}
  \فقره[\متن‌لاتین{Publish}] \پررا \\ این دستور یک پیام از سمت کلاینت را تحت یک عنوان خاص برای سرور ارسال می‌کند. پیام‌ها رشته‌هایی \متن‌لاتین{ASCII} با طول دلخواه هستند.
  \فقره[\متن‌لاتین{‌Subscribe}] \پررا \\ این دستور به سرور اعلام می‌کند که این کلاینت متقاضی دریافت پیام‌های، عنوان داده شده است.
  \فقره[\متن‌لاتین{Ping}] \پررا \\ این دستور از سمت کلاینت برای اطمنیان از ارتباط ارسال می‌گردد.
  \فقره[\متن‌لاتین{Pong}] \پررا \\ این دستور از سمت کلاینت در پاسخ به پیام \متن‌لاتین{Ping} ارسال می‌گردد.
  \پایان{توضیح}

  سرور به کلاینت:

  \شروع{توضیح}
  \فقره[\متن‌لاتین{Message}] \پررا \\ این دستور یک پیام از سمت سرور را برای کلاینت زمانی که متقاضی موضوعی است، ارسال می‌کند (دقت داشته باشید که این دستور شامل پیام و عنوان است). پیام‌ها رشته‌هایی \متن‌لاتین{ASCII} با طول دلخواه هستند.
  \فقره[\متن‌لاتین{SubAck}] \پررا \\ این دستور از سمت سرور در جهت تایید پیام \متن‌لاتین{Subscribe} کلاینت زمانی که عملیات \متن‌لاتین{Subscribe} موفقیت آمیز باشد ارسال می‌شود.
  \فقره[\متن‌لاتین{PubAck}] \پررا \\ این دستور از سمت سرور در جهت تایید پیام \متن‌لاتین{Publish} کلاینت زمانی عملیات \متن‌لاتین{Publish} موفقیت آمیز باشد ارسال می‌شود.
  \فقره[\متن‌لاتین{Ping}] \پررا \\ این دستور از سمت سرور برای اطمینان از ارتباط ارسال می‌گردد.
  \فقره[\متن‌لاتین{Pong}] \پررا \\ این دستور از سمت سرور در پاسخ به پیام \متن‌لاتین{Ping} ارسال می‌گردد.
  \پایان{توضیح}


  \قسمت{پیاده‌سازی سرور}

  سرور یک سوکت سرور دارد که روی یک پورت مشخص گوش می‌دهد (در اینجا فرض می‌کنیم پورت موردنظر ۱۳۷۳ است). از آنجایی که قصد داریم سرور چند ارتباط همزمان را هندل کند نیاز به ساخت \متن‌لاتین{Thread} برای هر کانکشن خواهید داشت
  تا تابع \متن‌لاتین{accept} بلافاصله فراخوانی شود. سرور هیچ ارتباطی را نمی‌بندد و همه ارتباط‌ها را به صورت باز نگه می‌دارد. برای سرور هر ارتباط یک کلاینت را نمایندگی می‌کند بنابراین می‌بایست لیست از سوکت‌ها و عناوین موردنظر آن‌ها داشته باشد.

  \begin{latin}
  \begin{minted}[bgcolor=LightGray]{python}
import socket
import threading

HOST = '127.0.0.1'  # Standard loopback interface address (localhost)
PORT = 1373         # Port to listen on (non-privileged ports are > 1023)

def handler(conn, addr):
    with conn:
        print('Connected by', addr)
        while True:
            data = conn.recv(1024)
            if not data:
                break
            conn.sendall(data)
        print('Disconnected by', addr)

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.bind((HOST, PORT))
    s.listen()
    while True:
        conn, addr = s.accept()
        threading.Thread(target=handler, args=(conn, addr)).start()
  \end{minted}
  \end{latin}

  دقت داشته باشید که سرور می‌بایست وضعیت کانکشن‌ها را نیز مدنظر داشته باشد و از ارسال داده بر روی کانکشن‌های بسته شده خودداری کند.

  \قسمت{پیاده‌سازی کلاینت}

  کلاینت به صورت یک ابزار درون ترمینالی پیاده‌سازی می‌شود و نیازی به پیاده‌سازی گرافیکی \متن‌سیاه{نیست}.
  کلاینت آرگومان‌های زیر را در زمان اجرا دریافت می‌کند. برای اطلاعات بیشتر از آرگومان‌ها در پایتون می‌توانید از \تارنما{https://realpython.com/python-command-line-arguments/}{اینجا} استفاده کنید.
  کلاینت دو دستور اصلی دارد:

  دستور \متن‌لاتین{Publish} پیام داده شده در آرگومان \متن‌لاتین{message} را تحت عنوان آرگومان \متن‌لاتین{topic} به سرور ارسال می‌کند.
  این دستور به مدت \متن‌سیاه{۱۰ ثانیه} تا رسیدن پیام \متن‌لاتین{PubAck} از سمت سرور صبر می‌کند و در صورت دریافت موفقیت آمیز، به کاربر اطلاع می‌دهد.
  در غیر این صورت خطای مناسبی نمایش داده می‌شود.

  \begin{latin}
  \begin{minted}[bgcolor=LightGray]{bash}
> python3 client.py <host> <port> publish <topic> <message>

> your message published successfully # in case of success

> your message publishing failed # in case of failure
  \end{minted}
  \end{latin}

  دستور \متن‌لاتین{Subscribe} به سرور اطلاع می‌دهد که متقاضی دریافت پیام‌های عنوان‌های داده شده تحت آرگومان‌های \متن‌لاتین{topic} هستیم.
  دقت کنید این دستور را می‌شود با یک یا بیشتر \متن‌لاتین{topic} فراخوانی کرد و شما نیاز دارید برای داشتن همزمان چند کانکشن با سرور از \متن‌لاتین{Thread} (برای اطلاعات بیشتر می‌توانید به \تارنما{https://realpython.com/intro-to-python-threading/}{اینجا} مراجعه کنید) استفاده کنید.
  برای هر عنوان شما نیاز به یک عملیات \متن‌لاتین{Subscribe} شما نیاز به ارسال یک پیام \متن‌لاتین{Subscribe} و دریافت یک پیام \متن‌لاتین{SubAck} در مدت محدود \متن‌سیاه{۱۰ ثانیه} دارید.
  در صورتی که پیام \متن‌لاتین{SubAck} در این مدت محدود دریافت نشود برنامه شما می‌بایست با پیام مناسب خاتمه پیدا کند.
  در نهایت برنامه می‌بایست روی همه سوکت‌های ساخته شده گوش فرا دهد تا پیام‌های دریافتی در قالب دستور \متن‌لاتین{Message} را به کاربر نمایش دهد.

  \begin{latin}
  \begin{minted}[bgcolor=LightGray]{bash}
> python3 client.py <host> <port> subscribe <topic-1> <topic-2> ... <topic-n>

> # in case of success
> subscribing on <topic-1> <topic-2> ... <topic-n>
> <topic-1>: message
> <topic-2>: message
> <topic-1>: message

> # in case of failure
> subscribing failed
  \end{minted}
  \end{latin}


  \قسمت{امتیازی‌ها}

  \شروع{فقرات}
  \فقره کلاینت در هر دو حالت می‌بایست به پیام‌های \متن‌لاتین{Ping} از سمت سرور با پیام \متن‌لاتین{Pong} پاسخ دهد.
  \فقره سرور می‌بایست به صورت دوره‌های \متن‌سیاه{۱۰ ثانیه‌ای} پیام‌های \متن‌لاتین{Ping} به کلاینت ارسال کند و در صورت نگرفتن جواب تا شروع دوره‌ی بعدی، اطلاعات آدرس آی پی و پورت کلاینت مورد نظر را چاپ کند.
  \فقره در صورتی که کلاینت سه دوره متوالی به پیام \متن‌لاتین{Ping} پاسخ نداد کانکشن کلاینت بسته شده و از لیست کلاینت‌ها حذف شود.
  \فقره شما بایستی پیامی که از سمت \متن‌لاتین {Publisher} دریافت می‌کنید در \متن‌لاتین {Broker} در یک صف نگه‌دارید و تا زمانی که برای \متن‌لاتین {Client} می‌فرستید و از صحت رسیدن آن(یعنی بازگشت \متن‌لاتین {Ack} از کاربر) مطمئن شود.
  \فقره درصورتی که پیام فرستاده شده به \متن‌لاتین  {Broker} توسط \متن‌لاتین {Publisher} به {Client} فرستاده نشد یا به هر دلیلی در صف باقی ماند و در ادامه برای همین موضوع از سمت \متن‌لاتین {Publisher} پیام دیگری دریافت شد بایستی پیام قبلی حذف شود و پیام جدید در آن صف قرار بگیرد.
  \پایان{فقرات}

  \قسمت{تحویل‌دادنی‌ها}

  \شروع{فقرات}
  \فقره طراحی و توضیح پروتکل و نحوه ارسال داده‌ها. در این تمرین عملی دستورات متعددی تعریف شده است و شما می‌بایست مشخص کنید که این دستورات را چگونه بر روی ارتباط \متن‌لاتین{TCP} بین کلاینت و سرور جابجا می‌کنید.
  \فقره پیاده‌سازی سرور با زبان برنامه‌نویسی مورد نظر شما
  \فقره پیاده‌سازی کلاینت با زبان برنامه‌نویسی مورد نظر شما
  \پایان{فقرات}

  \قسمت{نکات}

  \شروع{فقرات}
  \فقره تمرین‌های عملی را می‌بایست به صورت \متن‌سیاه{انفرادی} انجام دهید.
  \فقره تمرین عملی نباید هیچ‌گونه \متن‌لاتین{exception} یا خطای ناخواسته‌ای داشته باشد. تمام خطاهای شما می‌بایست به درستی هندل شده یا حداقل در کد دارای کامنت باشند و علت وقوع آن ذکر شده باشد.
  \فقره هرگونه کپی‌برداری یا تقلب در صورت تشخیص نمره طرفین را صفر خواهد کرد.
  \فقره آموزش برنامه‌نویسی سوکت با پایتون در آزمایشگاه انجام شده است و لینک‌های لازم برای این زبان نیز در این صورت تمرین وجود دارد ولی انتخاب زبان برنامه‌نویسی آزاد است.
  \پایان{فقرات}

  \فضای‌و*{\پر}
  \شروع{وسط‌چین}
این سند برپایه بسته \متن‌لاتین{\زی‌پرشین} گونه \متن‌لاتین{\گونه‌زی‌پرشین} توسعه پیدا کرده است.
  \پایان{وسط‌چین}

\end{document}
